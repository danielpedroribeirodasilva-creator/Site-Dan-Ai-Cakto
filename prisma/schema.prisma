// =============================================================================
// PRISMA SCHEMA - PLATAFORMA IA SAAS
// =============================================================================
// Complete database schema with all models, relations, and indexes
// Supports PostgreSQL with PGVector extension for embeddings

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pgvector(map: "vector"), pg_trgm]
}

// =============================================================================
// ENUMS
// =============================================================================

/// User roles for RBAC (Role-Based Access Control)
enum Role {
  USER
  MODERATOR
  ADMIN
}

/// Plan tiers available in the platform
enum PlanTier {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

/// Credit transaction types for audit logging
enum TransactionType {
  CONSUMPTION   // Credits used for AI operations
  REFILL        // Daily/monthly credit refills
  PURCHASE      // Credits purchased via payment
  BONUS         // Promotional or referral credits
  REFUND        // Refunded credits
  ADJUSTMENT    // Manual adjustment by admin
}

/// Project status for workflow tracking
enum ProjectStatus {
  DRAFT
  GENERATING
  READY
  DEPLOYED
  ARCHIVED
  FAILED
}

/// Conversation status
enum ConversationStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

/// Message role in conversations
enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// =============================================================================
// MODELS
// =============================================================================

/// User model - Core user entity synced with Auth0
model User {
  id          String   @id @default(cuid())
  auth0Sub    String   @unique @map("auth0_sub") // Auth0 subject identifier
  email       String   @unique
  name        String?
  picture     String?  // Avatar URL from Auth0/Google
  role        Role     @default(USER)
  credits     Float    @default(5.0) // Available credits
  planId      String   @default("free") @map("plan_id")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  lastLoginAt DateTime @default(now()) @map("last_login_at")
  
  // User preferences stored as JSON
  preferences Json     @default("{\"theme\": \"dark\", \"language\": \"pt-BR\", \"notifications\": true, \"reducedMotion\": false}")
  
  // Metadata
  emailVerified Boolean @default(false) @map("email_verified")
  isActive      Boolean @default(true) @map("is_active")
  
  // Relations
  plan              Plan?                @relation(fields: [planId], references: [id])
  projects          Project[]
  conversations     Conversation[]
  creditTransactions CreditTransaction[]
  auditLogs         AuditLog[]
  apiKeys           ApiKey[]
  
  @@index([email])
  @@index([auth0Sub])
  @@index([role])
  @@map("users")
}

/// Plan model - Subscription plans
model Plan {
  id              String    @id @default(cuid())
  name            String    @unique // e.g., "Free", "Basic", "Pro", "Enterprise"
  tier            PlanTier  @default(FREE)
  description     String?
  
  // Pricing
  priceMonthly    Float     @default(0) @map("price_monthly")
  priceYearly     Float     @default(0) @map("price_yearly")
  currency        String    @default("BRL")
  
  // Limits
  creditsMonthly  Float     @default(5) @map("credits_monthly") // Monthly credit allowance
  creditsDaily    Float     @default(1) @map("credits_daily")   // Daily refill amount
  maxProjects     Int       @default(10) @map("max_projects")
  maxSitesPerMonth Int      @default(0) @map("max_sites_per_month")
  
  // Features as JSON array
  features        Json      @default("[]")
  
  // Stripe integration
  stripePriceId   String?   @unique @map("stripe_price_id")
  
  // Status
  isActive        Boolean   @default(true) @map("is_active")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  users           User[]
  
  @@index([tier])
  @@map("plans")
}

/// Project model - User-created apps/sites
model Project {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  name        String
  slug        String
  description String?
  
  // Project data
  status      ProjectStatus @default(DRAFT)
  prompt      String?       @db.Text // Original prompt used to generate
  techStack   Json          @default("{}") @map("tech_stack") // Selected technologies
  files       Json          @default("{}") // File tree structure: { path: content }
  
  // Deployment
  previewUrl  String?       @map("preview_url")
  deployedUrl String?       @map("deployed_url")
  
  // Credits
  creditsCost Float         @default(0) @map("credits_cost")
  
  // Metadata
  isPublic    Boolean       @default(false) @map("is_public")
  version     Int           @default(1)
  
  // Timestamps
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  deletedAt   DateTime?     @map("deleted_at")
  
  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, slug])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("projects")
}

/// Conversation model - Chat threads with AI
model Conversation {
  id        String             @id @default(cuid())
  userId    String             @map("user_id")
  title     String             @default("Nova Conversa")
  status    ConversationStatus @default(ACTIVE)
  
  // Fork support
  parentId  String?            @map("parent_id")
  
  // Metadata
  messageCount Int             @default(0) @map("message_count")
  totalTokens  Int             @default(0) @map("total_tokens")
  
  // Timestamps
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")
  
  // Relations
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Conversation?      @relation("ConversationForks", fields: [parentId], references: [id])
  forks     Conversation[]     @relation("ConversationForks")
  messages  Message[]
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("conversations")
}

/// Message model - Individual messages in conversations
model Message {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  role           MessageRole
  content        String       @db.Text
  
  // Attachments (images, PDFs, etc.)
  attachments    Json         @default("[]")
  
  // AI metadata
  model          String?      // AI model used
  tokens         Int          @default(0)
  
  // Embedding for semantic search (PGVector)
  // embedding      Unsupported("vector(1536)")?
  
  // Timestamps
  createdAt      DateTime     @default(now()) @map("created_at")
  
  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
  @@map("messages")
}

/// CreditTransaction model - Audit log for all credit operations
model CreditTransaction {
  id          String          @id @default(cuid())
  userId      String          @map("user_id")
  type        TransactionType
  amount      Float           // Positive for additions, negative for deductions
  balance     Float           // Balance after transaction
  
  // Context
  description String?
  referenceId String?         @map("reference_id") // Related entity ID (project, conversation, etc.)
  referenceType String?       @map("reference_type") // Type of related entity
  
  // Metadata
  metadata    Json            @default("{}")
  
  // Timestamps
  createdAt   DateTime        @default(now()) @map("created_at")
  
  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("credit_transactions")
}

/// AuditLog model - System-wide audit logging
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String   // e.g., "user.login", "project.create", "credits.deduct"
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  
  // Request context
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  
  // Details
  details    Json     @default("{}")
  
  // Status
  success    Boolean  @default(true)
  errorMessage String? @map("error_message")
  
  // Timestamps
  createdAt  DateTime @default(now()) @map("created_at")
  
  // Relations
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

/// ApiKey model - API keys for programmatic access
model ApiKey {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String
  keyHash     String    @unique @map("key_hash") // Hashed API key
  keyPrefix   String    @map("key_prefix") // First 8 chars for identification
  
  // Permissions
  scopes      String[]  @default(["read"]) // e.g., ["read", "write", "admin"]
  
  // Rate limiting
  rateLimit   Int       @default(100) @map("rate_limit") // Requests per minute
  
  // Status
  isActive    Boolean   @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([keyPrefix])
  @@map("api_keys")
}

/// SystemSetting model - Global system configuration
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  
  // Metadata
  description String?
  isPublic    Boolean @default(false) @map("is_public")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}
